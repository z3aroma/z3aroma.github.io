<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Modifica Citofoni Z3A</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .login-container {
            padding: 40px;
            text-align: center;
        }
        .login-form {
            max-width: 300px;
            margin: 0 auto;
        }
        .login-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .login-form button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .login-form button:hover {
            background: #0056b3;
        }
        .error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }
        .admin-panel {
            display: none;
            padding: 20px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn-save {
            background: #007bff;
        }
        .btn-add {
            background: #28a745;
        }
        .btn-logout {
            background: #dc3545;
            margin-left: auto;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .editable {
            background: transparent;
            border: 1px solid transparent;
            padding: 8px;
            width: 100%;
        }
        .editable:focus {
            border: 1px solid #007bff;
            outline: none;
            background: white;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #007bff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Amministrazione Citofoni Z3A</h1>
        </div>
        
        <!-- Login Form -->
        <div class="login-container" id="loginContainer">
            <div class="login-form">
                <h2>Accesso Amministratore</h2>
                <input type="password" id="passwordInput" placeholder="Inserisci password" autocomplete="current-password">
                <button onclick="login()">Accedi</button>
                <div class="error-message" id="errorMessage">Password errata!</div>
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div class="admin-panel" id="adminPanel">
            <div class="status-message status-success" id="successMessage"></div>
            <div class="status-message status-error" id="errorMessagePanel"></div>
            
            <div class="controls">
                <button class="btn btn-add" onclick="addRow()">âž• Aggiungi Riga</button>
                <button class="btn btn-save" onclick="saveChanges()">ðŸ’¾ Salva Modifiche</button>
                <button class="btn btn-logout" onclick="logout()">Esci</button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Caricamento in corso...</p>
            </div>
            
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Cognome</th>
                            <th>Citofono</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configurazione
        const PASSWORD = 'Gatto7Roma3Stelle9Luna2Casa'; // Password di accesso
        
        // Dati criptati con AES (sicuro)
        const ENCRYPTED_TOKEN = 'U2FsdGVkX1/L+M1Ad+UWG3SngXEctgdRc3zUKEJuX9edd5DYlz5ulwvv0inDREzdekvfgSXKW9oLI01M9H4ivQ==';
        const ENCRYPTED_REPO_OWNER = 'U2FsdGVkX18ng1Ff4E8dtj8ajLBOFNc++8saBqc/c88=';
        const ENCRYPTED_REPO_NAME = 'U2FsdGVkX1/HB47l1wLYUcI9Rd+q4bEB3HUqOPXySAzu/5D96zRYp3Iuu5lGP49z';
        const ENCRYPTED_CSV_PATH = 'U2FsdGVkX18ObJTo3ZJpVdoA0Kqp5e85kFRRwdRwIaLvVlGmU/Mu6IpokC2GghX0';
        
        // Variabili che saranno popolate dopo la decriptazione
        let GITHUB_TOKEN = null;
        let REPO_OWNER = null;
        let REPO_NAME = null;
        let CSV_PATH = null;
        let csvData = [];
        let isLoggedIn = false;
        
        // Funzione di login con decriptazione di tutti i dati
        function login() {
            const password = document.getElementById('passwordInput').value;
            
            try {
                // Tenta di decriptare tutti i dati con la password
                const decryptedToken = CryptoJS.AES.decrypt(ENCRYPTED_TOKEN, password).toString(CryptoJS.enc.Utf8);
                const decryptedOwner = CryptoJS.AES.decrypt(ENCRYPTED_REPO_OWNER, password).toString(CryptoJS.enc.Utf8);
                const decryptedRepo = CryptoJS.AES.decrypt(ENCRYPTED_REPO_NAME, password).toString(CryptoJS.enc.Utf8);
                const decryptedPath = CryptoJS.AES.decrypt(ENCRYPTED_CSV_PATH, password).toString(CryptoJS.enc.Utf8);
                
                // Verifica che il token sia valido
                if (decryptedToken && decryptedToken.startsWith('ghp_')) {
                    // Password corretta, tutti i dati decriptati con successo
                    GITHUB_TOKEN = decryptedToken;
                    REPO_OWNER = decryptedOwner;
                    REPO_NAME = decryptedRepo;
                    CSV_PATH = decryptedPath;
                    
                    console.log('Configurazione decriptata con successo');
                    
                    isLoggedIn = true;
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadData();
                } else {
                    // Password errata
                    showLoginError();
                }
            } catch (e) {
                // Errore di decriptazione = password errata
                console.error('Errore decriptazione:', e);
                showLoginError();
            }
        }
        
        // Mostra errore di login
        function showLoginError() {
            document.getElementById('errorMessage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
            }, 3000);
        }
        
        // Funzione di logout
        function logout() {
            isLoggedIn = false;
            // Pulisce tutti i dati sensibili dalla memoria
            GITHUB_TOKEN = null;
            REPO_OWNER = null;
            REPO_NAME = null;
            CSV_PATH = null;
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        }
        
        // Carica i dati dal CSV
        async function loadData() {
            if (!isLoggedIn) return;
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Ottieni il contenuto del file da GitHub
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CSV_PATH}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Errore nel caricamento dei dati');
                }
                
                const data = await response.json();
                const content = atob(data.content);
                
                // Salva il SHA per l'aggiornamento successivo
                window.currentSHA = data.sha;
                
                // Parsa il CSV
                parseCSV(content);
                renderTable();
                
            } catch (error) {
                console.error('Errore:', error);
                showError('Errore nel caricamento dei dati. Verifica il token GitHub.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Parsa il CSV
        function parseCSV(content) {
            const lines = content.trim().split('\n');
            csvData = [];
            
            // Salta l'header
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(';');
                if (parts.length >= 2) {
                    csvData.push({
                        cognome: parts[0].trim(),
                        citofono: parts[1].trim()
                    });
                }
            }
        }
        
        // Renderizza la tabella
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            csvData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input class="editable" type="text" value="${row.cognome}" onchange="updateData(${index}, 'cognome', this.value)"></td>
                    <td><input class="editable" type="text" value="${row.citofono}" onchange="updateData(${index}, 'citofono', this.value)"></td>
                    <td><button class="delete-btn" onclick="deleteRow(${index})">Elimina</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Aggiorna i dati
        function updateData(index, field, value) {
            csvData[index][field] = value;
        }
        
        // Aggiungi una nuova riga
        function addRow() {
            csvData.push({
                cognome: 'NUOVO COGNOME',
                citofono: '000'
            });
            renderTable();
            // Scrolla alla fine della tabella
            const table = document.querySelector('.table-container');
            table.scrollTop = table.scrollHeight;
        }
        
        // Elimina una riga
        function deleteRow(index) {
            if (confirm('Sei sicuro di voler eliminare questa riga?')) {
                csvData.splice(index, 1);
                renderTable();
            }
        }
        
        // Salva le modifiche su GitHub
        async function saveChanges() {
            if (!isLoggedIn) return;
            
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Crea il contenuto CSV
                let csvContent = 'COGNOME;CITOFONO\n';
                csvData.forEach(row => {
                    csvContent += `${row.cognome};${row.citofono}\n`;
                });
                // Rimuovi l'ultimo newline
                csvContent = csvContent.trim();
                
                // Codifica in base64
                const encodedContent = btoa(unescape(encodeURIComponent(csvContent)));
                
                // Prepara il commit
                const commitData = {
                    message: `Aggiornamento citofoni via admin panel - ${new Date().toLocaleString('it-IT')}`,
                    content: encodedContent,
                    sha: window.currentSHA
                };
                
                // Invia l'aggiornamento a GitHub
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CSV_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(commitData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Errore nel salvataggio');
                }
                
                const result = await response.json();
                window.currentSHA = result.content.sha;
                
                showSuccess('Modifiche salvate con successo!');
                
            } catch (error) {
                console.error('Errore:', error);
                showError('Errore nel salvataggio. Verifica i permessi del token.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Mostra messaggio di successo
        function showSuccess(message) {
            const elem = document.getElementById('successMessage');
            elem.textContent = message;
            elem.style.display = 'block';
            setTimeout(() => {
                elem.style.display = 'none';
            }, 5000);
        }
        
        // Mostra messaggio di errore
        function showError(message) {
            const elem = document.getElementById('errorMessagePanel');
            elem.textContent = message;
            elem.style.display = 'block';
            setTimeout(() => {
                elem.style.display = 'none';
            }, 5000);
        }
        
        // Gestisci invio con Enter nella password
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });
    </script>
</body>
</html>